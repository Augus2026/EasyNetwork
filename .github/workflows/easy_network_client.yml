name: easy network client

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.5'

      - name: Install VCPKG and dependencies
        id: vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git
          cd vcpkg
          .\bootstrap-vcpkg.bat
          .\vcpkg integrate install
          .\vcpkg install uthash kcp wolfssl

          $EXPORT_OUTPUT = .\vcpkg export uthash kcp wolfssl --raw --output=temp
          Write-Output "======EXPORT_OUTPUT=$EXPORT_OUTPUT======"
          $TOOLCHAIN_PATH = $EXPORT_OUTPUT | Select-String -Pattern "CMAKE_TOOLCHAIN_FILE=([^\s]+)" | ForEach-Object { $_.Matches.Groups[1].Value }
          Write-Output "Extracted toolchain path: $TOOLCHAIN_PATH"
          echo "VCPKG_CMAKE_TOOLCHAIN=$TOOLCHAIN_PATH" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
  
      - name: Configure with CMake
        run: |
          echo "current pwd: $(pwd)"
          cd EasyNetwork\libEasyNetwork
          cmake -S ./ -B ./build -DCMAKE_TOOLCHAIN_FILE=${{ env.VCPKG_CMAKE_TOOLCHAIN }}
          
      - name: Build
        run: |
          cd EasyNetwork\libEasyNetwork
          cmake --build ./build --config Release

      # - name: Install dependencies
      #   run: |
      #     cd EasyNetwork\flutter\
      #     flutter doctor
      #     flutter pub get
      #     flutter pub run ffigen --config ffigen.yaml
          
      # - name: Build Windows release
      #   run: |
      #     cd EasyNetwork\flutter\
      #     flutter build windows --release
